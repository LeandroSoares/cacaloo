name: Deploy to VPS Production - RESET

on:
  workflow_dispatch:
    inputs:
      reset:
        description: 'Reset database'
        required: true
        default: 'false'
        type: boolean

jobs:
  deploy:
    name: Deploy to production
    runs-on: ubuntu-latest
    environment: prd

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          PROJECT_DIR: ${{ secrets.PROD_DEPLOY_DIR }}
          ENV_DATA: ${{ secrets.ENV_DATA_PROD }}
        with:
          host: ${{ secrets.PROD_SSH_HOST }}
          username: ${{ secrets.PROD_SSH_USER }}
          key: ${{ secrets.PROD_SSH_PRIVATE_KEY }}
          port: ${{ secrets.PROD_SSH_PORT }}
          envs: PROJECT_DIR,ENV_DATA
          script: |
            # Definições
            TARGET_DIR="${PROJECT_DIR}"
            cd "$TARGET_DIR"
            git checkout main
            git pull origin main

            # Generate Version from Short Commit Hash
            VERSION=$(git rev-parse --short HEAD)
            sed -i "s/APP_VERSION=.*/APP_VERSION=$VERSION/" .env || echo "APP_VERSION=$VERSION" >> .env

            if [ ! -f "composer.phar" ]; then
                curl -sS https://getcomposer.org/installer | php
            fi
            php composer.phar install --no-dev --optimize-autoloader --no-interaction

            if [ "${{ inputs.reset }}" = "true" ]; then
                php artisan migrate:fresh --seed --force
            else
                php artisan migrate --force
            fi

            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            echo "✅ Deploy concluído com sucesso!"

      - name: Purge Cloudflare Cache
        if: success()
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
          -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          --data '{"purge_everything":true}'
